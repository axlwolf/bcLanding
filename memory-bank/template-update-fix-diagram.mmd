graph TB
    subgraph "ğŸ”´ PROBLEMA ANTERIOR (Pre-Fix)"
        USER1["ğŸ‘¤ Usuario<br/>Cambia Template"]
        FRONTEND1["ğŸ–¥ï¸ TemplateSelector<br/>EnvÃ­a Request"]
        API1["ğŸ”Œ API Update<br/>dynamic='error'<br/>âŒ Cache estÃ¡tico"]
        SUPABASE1["ğŸ—„ï¸ Supabase<br/>âœ… Actualiza BD"]
        PAGE1["ğŸ“„ page.tsx<br/>âŒ CachÃ© stale<br/>Muestra template anterior"]
        REFRESH1["ğŸ”„ Refresh Manual<br/>âŒ Requerido"]
        
        USER1 --> FRONTEND1
        FRONTEND1 --> API1
        API1 --> SUPABASE1
        SUPABASE1 -.-> PAGE1
        PAGE1 --> REFRESH1
    end
    
    subgraph "ğŸŸ¢ SOLUCIÃ“N IMPLEMENTADA (Post-Fix)"
        USER2["ğŸ‘¤ Usuario<br/>Cambia Template"]
        FRONTEND2["ğŸ–¥ï¸ TemplateSelector<br/>EnvÃ­a Request"]
        API2["ğŸ”Œ API Update<br/>âœ… dynamic='force-dynamic'<br/>âœ… revalidatePath('/')"]
        SUPABASE2["ğŸ—„ï¸ Supabase<br/>âœ… Actualiza BD<br/>âœ… No-cache headers"]
        CONFIG2["âš™ï¸ lib/config.ts<br/>âœ… revalidatePath() adicional"]
        PAGE2["ğŸ“„ page.tsx<br/>âœ… Cache invalidado<br/>âœ… Update inmediato"]
        SUCCESS2["âœ… Template Cambiado<br/>Sin refresh manual"]
        
        USER2 --> FRONTEND2
        FRONTEND2 --> API2
        API2 --> SUPABASE2
        API2 --> CONFIG2
        SUPABASE2 --> PAGE2
        CONFIG2 --> PAGE2
        PAGE2 --> SUCCESS2
    end
    
    subgraph "ğŸ“‹ CAMBIOS ESPECÃFICOS IMPLEMENTADOS"
        CHANGE1["ğŸ”§ Change #1<br/>API Templates Route<br/>dynamic: 'error' â†’ 'force-dynamic'"]
        CHANGE2["ğŸ”§ Change #2<br/>API Update Route<br/>+ revalidatePath('/')<br/>+ revalidatePath('/app')"]
        CHANGE3["ğŸ”§ Change #3<br/>lib/config.ts<br/>+ revalidatePath() en updateActiveTemplate()"]
        CHANGE4["ğŸ”§ Change #4<br/>Supabase Client<br/>+ cache-control: no-cache<br/>+ realtime optimization"]
    end
    
    subgraph "âŒ RESULTADO: NO FUNCIONÃ“"
        ISSUE1["ğŸš¨ Posibles Causas"]
        CACHE_ISSUE["ğŸ’¾ Next.js Cache<br/>MÃ¡s agresivo<br/>de lo esperado"]
        SSG_ISSUE["ğŸ“„ Static Generation<br/>Conflict con dynamic"]
        BUILD_ISSUE["ğŸ”¨ Build Config<br/>Vercel/Production<br/>behaves differently"]
        TIMING_ISSUE["â±ï¸ Race Condition<br/>revalidatePath timing"]
        
        ISSUE1 --> CACHE_ISSUE
        ISSUE1 --> SSG_ISSUE
        ISSUE1 --> BUILD_ISSUE
        ISSUE1 --> TIMING_ISSUE
    end
    
    subgraph "ğŸ” SIGUIENTE INVESTIGACIÃ“N"
        NEXT1["ğŸ§ª Probar router.replace()<br/>en lugar de router.refresh()"]
        NEXT2["ğŸ”„ Implementar window.location.reload()<br/>como fallback"]
        NEXT3["ğŸ“¡ Real-time Supabase<br/>subscriptions para UI"]
        NEXT4["ğŸ¯ Force-refresh mediante<br/>timestamp query params"]
        NEXT5["ğŸ—‚ï¸ Investigar build config<br/>y static optimization"]
    end
    
    %% Flow connections
    CHANGE1 -.-> API2
    CHANGE2 -.-> API2
    CHANGE3 -.-> CONFIG2
    CHANGE4 -.-> SUPABASE2
    
    %% Problem indicators
    API1 -.->|"âŒ No invalidation"| PAGE1
    API2 -.->|"âš ï¸ Still not working"| ISSUE1
    
    %% Color coding
    classDef problemStyle fill:#ffebee,stroke:#f44336,stroke-width:2px,color:#000
    classDef solutionStyle fill:#e8f5e8,stroke:#4caf50,stroke-width:2px,color:#000
    classDef changeStyle fill:#e3f2fd,stroke:#2196f3,stroke-width:2px,color:#000
    classDef issueStyle fill:#fff3e0,stroke:#ff9800,stroke-width:2px,color:#000
    classDef nextStyle fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px,color:#000
    
    class USER1,FRONTEND1,API1,SUPABASE1,PAGE1,REFRESH1 problemStyle
    class USER2,FRONTEND2,API2,SUPABASE2,CONFIG2,PAGE2,SUCCESS2 solutionStyle
    class CHANGE1,CHANGE2,CHANGE3,CHANGE4 changeStyle
    class ISSUE1,CACHE_ISSUE,SSG_ISSUE,BUILD_ISSUE,TIMING_ISSUE issueStyle
    class NEXT1,NEXT2,NEXT3,NEXT4,NEXT5 nextStyle